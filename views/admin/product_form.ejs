<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h4 text-gold mb-1"><%= product ? 'Editar produto' : 'Novo produto' %></h1>
    <p class="small text-muted mb-0">
      Preencha as informa√ß√µes do item que ser√° exibido no cat√°logo.
    </p>
  </div>
  <a href="/admin/produtos" class="btn btn-outline-gold btn-sm">Voltar</a>
</div>

<form
  method="post"
  action="<%= product ? '/admin/produtos/' + product.id + '/editar' : '/admin/produtos/novo' %>"
  enctype="multipart/form-data"
  class="row g-3"
>
  <div class="col-12 col-md-6">
    <label for="name" class="form-label">Nome do produto</label>
    <input
      type="text"
      id="name"
      name="name"
      class="form-control bg-dark text-light border-gold"
      value="<%= product ? product.name : '' %>"
      required
    />
  </div>

  <div class="col-12 col-md-3">
    <label for="price" class="form-label">Pre√ßo (R$)</label>
    <input
      type="number"
      step="0.01"
      min="0"
      id="price"
      name="price"
      class="form-control bg-dark text-light border-gold"
      value="<%= product && product.price != null ? product.price : '' %>"
    />
  </div>

  <div class="col-12 col-md-3">
    <label for="category_id" class="form-label">Categoria</label>
    <select
      id="category_id"
      name="category_id"
      class="form-select bg-dark text-light border-gold"
    >
      <option value="">Sem categoria</option>
      <% categories.forEach(function (c) { %>
        <option
          value="<%= c.id %>"
          <%= product && product.category_id === c.id ? 'selected' : '' %>
        >
          <%= c.name %>
        </option>
      <% }) %>
    </select>
  </div>

  <div class="col-12">
    <label class="form-label">Imagem do Produto</label>
    <div class="border border-gold rounded p-3 bg-dark mb-3">
      <div class="mb-3">
        <label for="product_image" class="form-label text-gold">
          <strong>üì§ Fazer Upload de Imagem (Recomendado)</strong>
        </label>
        <input
          type="file"
          id="product_image"
          name="product_image"
          accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
          class="form-control bg-dark text-light border-gold"
          onchange="previewUploadedImage(this)"
        />
        <div class="form-text text-muted mt-1">
          Formatos aceitos: JPEG, JPG, PNG, GIF, WEBP (m√°ximo 5MB)
        </div>
      </div>
      
      <div class="text-center text-muted mb-3" style="font-size: 0.9rem;">OU</div>
      
      <div>
        <label for="image_url" class="form-label text-gold">
          <strong>üîó Usar URL de Imagem Externa</strong>
        </label>
        <input
          type="url"
          id="image_url"
          name="image_url"
          class="form-control bg-dark text-light border-gold"
          placeholder="https://exemplo.com/imagem.jpg"
          value="<%= product ? product.image_url || '' : '' %>"
          oninput="previewImage(this.value)"
        />
        <div class="form-text text-muted mt-1">
          <strong>Como obter a URL da imagem:</strong>
          <ul class="small mb-0 mt-1">
            <li><strong>Instagram:</strong> Clique com bot√£o direito na foto ‚Üí "Copiar endere√ßo da imagem"</li>
            <li><strong>Google Drive:</strong> Compartilhe a imagem como "Qualquer pessoa com o link" ‚Üí Copie o link e substitua <code>/view</code> por <code>/uc?export=view&id=</code></li>
            <li><strong>Imgur/Outros:</strong> Fa√ßa upload e copie o link direto da imagem</li>
          </ul>
        </div>
      </div>
    </div>
    
    <div id="imagePreview" class="mt-3" style="display: none;">
      <label class="form-label small">Pr√©-visualiza√ß√£o:</label>
      <div class="border border-gold rounded p-2 bg-dark d-inline-block">
        <img id="previewImg" src="" alt="Preview" style="max-width: 200px; max-height: 200px; object-fit: contain;" class="img-fluid" />
      </div>
    </div>
    
    <% if (product && product.image_url) { %>
      <div class="mt-3">
        <label class="form-label small">Imagem Atual:</label>
        <div class="border border-gold rounded p-2 bg-dark d-inline-block">
          <img src="<%= product.image_url %>" alt="Imagem atual" style="max-width: 200px; max-height: 200px; object-fit: contain;" class="img-fluid" />
        </div>
        <div class="form-text text-muted mt-1">
          Se voc√™ fizer upload de uma nova imagem, esta ser√° substitu√≠da.
        </div>
      </div>
    <% } %>
  </div>

  <div class="col-12">
    <label for="description" class="form-label">Descri√ß√£o do produto</label>
    <textarea
      id="description"
      name="description"
      rows="4"
      class="form-control bg-dark text-light border-gold"
      placeholder="Descreva o produto, suas caracter√≠sticas, materiais, cores dispon√≠veis, etc."
    ><%= product ? product.description || '' : '' %></textarea>
    <div class="form-text text-muted">
      Esta descri√ß√£o aparecer√° no cat√°logo p√∫blico. Seja detalhado para atrair mais clientes!
    </div>
  </div>

  <div class="col-12">
    <label for="mercado_pago_link" class="form-label">Link do Mercado Pago</label>
    <input
      type="url"
      id="mercado_pago_link"
      name="mercado_pago_link"
      class="form-control bg-dark text-light border-gold"
      placeholder="https://www.mercadopago.com.br/checkout/v1/redirect?pref_id=..."
      value="<%= product ? product.mercado_pago_link || '' : '' %>"
    />
    <div class="form-text text-muted">
      <strong>Como obter o link do Mercado Pago:</strong>
      <ul class="small mb-0 mt-1">
        <li>Acesse sua conta no Mercado Pago</li>
        <li>Crie um link de pagamento para este produto</li>
        <li>Copie o link gerado e cole aqui</li>
        <li>Se deixar em branco, o bot√£o de compra n√£o aparecer√° (apenas WhatsApp)</li>
      </ul>
    </div>
  </div>

  <div class="col-12 d-flex justify-content-end">
    <button type="submit" class="btn btn-gold">
      <%= product ? 'Atualizar produto' : 'Adicionar produto' %>
    </button>
  </div>
</form>

<script>
  function previewImage(url) {
    const previewDiv = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    
    if (url && url.trim() !== '') {
      previewImg.src = url;
      previewImg.onload = function() {
        previewDiv.style.display = 'block';
      };
      previewImg.onerror = function() {
        previewDiv.style.display = 'none';
      };
    } else {
      previewDiv.style.display = 'none';
    }
  }
  
  function previewUploadedImage(input) {
    const previewDiv = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const fileInput = document.getElementById('image_url');
    
    if (input.files && input.files[0]) {
      const file = input.files[0];
      
      // Validar tamanho (5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('A imagem √© muito grande! M√°ximo permitido: 5MB');
        input.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        previewDiv.style.display = 'block';
        // Limpar campo de URL quando upload √© selecionado
        if (fileInput) {
          fileInput.value = '';
        }
      };
      reader.readAsDataURL(file);
    } else {
      previewDiv.style.display = 'none';
    }
  }
  
  // Carregar preview se j√° houver imagem ao editar
  <% if (product && product.image_url) { %>
    window.addEventListener('DOMContentLoaded', function() {
      previewImage('<%= product.image_url %>');
    });
  <% } %>
</script>


